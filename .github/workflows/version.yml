name: Auto Increment Version & Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'VERSION'
      - '.github/workflows/version.yml'

jobs:
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Increment Version
        id: version
        run: |
          # Read current version
          VERSION=$(cat VERSION)
          
          # Split version into parts
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Increment patch version
          PATCH=$((PATCH + 1))
          
          # Roll over patch to minor at 100
          if [ $PATCH -ge 100 ]; then
            PATCH=0
            MINOR=$((MINOR + 1))
          fi
          
          # Roll over minor to major at 100
          if [ $MINOR -ge 100 ]; then
            MINOR=0
            MAJOR=$((MAJOR + 1))
          fi
          
          # Create new version
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          
          # Write new version
          echo "$NEW_VERSION" > VERSION
          
          echo "old_version=$VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Updated version from $VERSION to $NEW_VERSION"

      - name: Commit and Push
        run: |
          git add VERSION
          git diff --staged --quiet || git commit -m "chore: bump version to $(cat VERSION) [skip ci]"
          git push

      - name: Create Tag
        run: |
          git tag v${{ steps.version.outputs.new_version }}
          git push origin v${{ steps.version.outputs.new_version }}

      - name: Generate Release Notes
        id: notes
        run: |
          echo "## ðŸš€ Profile Update v${{ steps.version.outputs.new_version }}" > release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“… Released: $(date +'%B %d, %Y')" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“ Changes" >> release_notes.md
          git log --oneline v${{ steps.version.outputs.old_version }}..HEAD --pretty=format:"- %s" 2>/dev/null >> release_notes.md || echo "- Initial release" >> release_notes.md
          echo "" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "*Automatically generated by GitHub Actions*" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          name: "Profile v${{ steps.version.outputs.new_version }}"
          body_path: release_notes.md
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
